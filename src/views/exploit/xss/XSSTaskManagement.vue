<template>
    <div>
        <v-data-table
                :headers="headers"
                :items="items"
                hide-default-footer
                :page.sync="pageCurrent"
                :items-per-page="pageSize"
                @page-count="pageCount = $event"
                :loading="spinShow"
                item-key="tid"
                loading-text="Loading... Please wait"
                :search="search"
                show-select
                v-model="selected"
                no-data-text=""
        >
            <template v-slot:item.name="{ item }">
                <span @click="getTaskResult(item['tid'])" class="teal--text">{{item['name']}}</span>
            </template>

            <template v-slot:item.salt="{ item }">
                <v-btn @click="getXSSJSPath(item['salt'])"  x-small elevation="0" color="success">
                    COPY
                </v-btn>
            </template>

            <template v-slot:item.count="{ item }">
                <v-btn  x-small elevation="0" :color="item['count'] === 0 ? 'grey lighten-3' : 'error'">
                    {{item['count']}}
                </v-btn>
            </template>

            <template v-slot:item.action="{ item }">
                <v-icon @click="deleteTask(item['tid'])" class="error--text">mdi-trash-can-outline</v-icon>
            </template>
        </v-data-table>
        <v-row v-if="items.length === 0" justify="center" class="grey--text mb-12">
            <h2>No available data</h2>
            <br>
        </v-row>
        <v-divider/>
        <v-row>
            <v-col cols="12">
                <div class="float-right mt-1 mr-3">
                    <v-pagination
                            color="teal"
                            v-model="pageCurrent"
                            :length="Math.ceil(items.length / pageSize)"
                            :total-visible="7"
                    ></v-pagination>
                </div>
            </v-col>
        </v-row>
    </div>
</template>

<script>
    export default {
        name: "XSSTaskManagement",
        data: () => ({
            spinShow: true,
            items: [],
            pageCurrent: 1,
            pageSize: 10,
            search: "",
            selected: [],
            headers: [
                { text: 'Name', value: 'name' },
                { text: 'Payload', value: 'payload_name' },
                { text: 'JS Path', value: 'salt' },
                { text: 'Sheep', value: 'count' },
                { text: 'Create Date', value: 'date' },
                { text: 'OP', value: 'op' },
                { text: 'Action', value: 'action' },
            ],
            deleteMultiDialog: false,
        }),
        mounted() {
            this.getData();
            this.spinShow = false
        },
        methods: {
            getData() {
                this.$api.exploit.xssTaskList().then(res => {
                    let response = res.data;
                    let status = response['status'];
                    let result = response['result'];
                    if (status['status'] === "success") {
                        this.items = result
                    } else {
                        this.$message.error(status['message']);
                    }
                });
            },

            deleteTask(tid) {
                this.$api.exploit.xssTaskDelete(tid).then(res => {
                    let response = res.data;
                    let status = response['status'];
                    if (status['status'] === "success") {
                        this.$message.success(status['message']);
                    } else {
                        this.$message.error(status['message']);
                    }
                    this.getData();
                })
            },

            getTaskResult(tid) {
                window.open('#/exploit/xss/result?tid=' + tid, "_blank");
            },

            getXSSJSPath(salt) {
                let url = this.$api.SERVER_ADDER;
                url = url.replace("/api/v1", "");
                url = url.replace("/api/v2", "");
                url += "/x/" + salt;

                let oInput = document.createElement("input");
                oInput.value = url;
                document.body.appendChild(oInput);
                oInput.select();
                document.execCommand("Copy");
                oInput.className = "oInput";
                oInput.style.display = "none";
                this.$message.success("Copy success");
                window.open(url,"_blank")
            },
        }
    }
</script>

<style scoped>

</style>