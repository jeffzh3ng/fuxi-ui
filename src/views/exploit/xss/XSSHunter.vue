<template>
    <div>
        <v-card-title>
            <v-list-item-action>
                <v-icon class="teal--text">mdi-clipboard-list-outline</v-icon>
            </v-list-item-action>
            <v-list-item-content class="ml-n4">
                <v-list-item-title class="teal--text">
                    <span>XSS HUNTER</span>
                </v-list-item-title>
            </v-list-item-content>
        </v-card-title>

        <v-row class="mt-n4 ml-2">
            <v-col cols="12">
            <v-tabs v-model="tab">
                <v-btn @click="openNewTask" elevation="0"  class="mr-8 mt-3 ml-2" small color="teal">
                    <span class="white--text">new task</span>
                </v-btn>
                <v-tab key="tasks">
                    Tasks
                </v-tab>
                <v-tab key="payload">
                    Payload
                </v-tab>
            </v-tabs>

            <v-tabs-items v-model="tab">
                <v-tab-item key="tasks" class="ml-n2">
                    <v-col cols="12">
                        <XSSTaskManagement ref="XSSTaskManagement"/>
                    </v-col>
                </v-tab-item>

                <v-tab-item key="payload">
                    <v-col cols="12">
                        <XSSPayloadManagement/>
                    </v-col>
                </v-tab-item>
            </v-tabs-items>
            </v-col>
            <v-dialog v-model="newTaskDialogOpen" width="500px">
                <v-card>
                    <v-card-title>
                        <span class="headline">New task</span>
                    </v-card-title>
                    <v-card-text>
                        <v-row>
                            <v-col cols="12">
                                <v-text-field
                                        label="Task Name"
                                        class="mr-2 ml-2"
                                        v-model="newTaskData.name"
                                        :rules="[v => !!v || 'Task name is required']"
                                        persistent-hint
                                        required
                                ></v-text-field>
                            </v-col>
                            <v-col cols="7">
                                <v-select
                                        class="ml-2 mr-2 mt-n4"
                                        :items="payloadList"
                                        single-line
                                        v-model="newTaskData.payload"
                                />
                            </v-col>
                            <v-col cols="12" >
                                <v-btn @click="newTask" small color="teal" class="float-right ml-2 mr-2 mb-4">
                                    <span class="white--text">Create</span>
                                </v-btn>
                            </v-col>
                        </v-row>
                    </v-card-text>
                </v-card>
            </v-dialog>
        </v-row>
    </div>
</template>

<script>
    import XSSTaskManagement from "./XSSTaskManagement"
    import XSSPayloadManagement from "./XSSPayloadManagement"
    export default {
        name: "XSSHunter",
        components: {
            XSSTaskManagement,
            XSSPayloadManagement,
        },
        data: () => ({
            search: "",
            tab: null,
            newTaskDialogOpen: false,
            newTaskData: {name: "", payload: ""},
            payloadList: [],
        }),
        mounted() {
            this.getPayload()
        },
        methods: {
            getPayload() {
                this.$api.exploit.xssPayloadList().then(res => {
                    let response = res.data;
                    let status = response['status'];
                    let result = response['result'];
                    this.payloadList = [];
                    if(status['status'] === "success") {
                        for (let i=0; i<result.length; i++) {
                            this.payloadList.push({
                                value: result[i]['pid'],
                                text: result[i]['name'],
                            })
                        }
                    } else {
                        this.$message.error(status['message']);
                    }
                })
            },
            openNewTask() {
                this.newTaskDialogOpen = true;
                this.getPayload();
                this.newTaskData.name = "xss_task_" + this.$tools.getDateTime();
                this.newTaskData.payload = this.payloadList[0];
            },
            newTask() {
                let data = {
                    name: this.newTaskData.name,
                    payload: this.newTaskData.payload.value
                };
                if (data.name.length === 0 || data.payload.length === 0) {
                    this.$message.error("Please check you input");
                    return
                }
                this.newTaskDialogOpen = false;
                this.$api.exploit.xssNewTask(data).then(res => {
                    let response = res.data;
                    let status = response['status'];
                    if(status['status'] === "success") {
                        this.$message.success(status['message']);
                        this.$refs.XSSTaskManagement.getData();
                    } else {
                        this.$message.error(status['message']);
                    }
                });
            },
        }
    }
</script>

<style scoped>

</style>