<template>
  <div>
    <d-row>
      <d-col>
        <d-form>
          <d-form-row class="mx-3">
            <d-col md="6" class="form-group">
              <Select @on-change="selectPayload" v-model="payloadItem.name" filterable>
                <Option v-for="item in items" :value="item.name" :key="item.name">{{ item.name }}</Option>
              </Select>
            </d-col>
            <d-col md="6">
              <d-button @click="openNewPayloadModal=true" size="sm" class="btn-accent ml-auto">
                <i class="material-icons mr-1">library_add</i>
                <strong>New Payload</strong>
              </d-button>
<!--              <Button @click="openNewPayloadModal=true">-->
<!--                <i class="material-icons mr-1">add_box</i>-->
<!--                New Payload-->
<!--              </Button>-->
            </d-col>
          </d-form-row>
          <d-form-row class="mx-3">
            <d-col md="6">
              <Input v-model="payloadItem.value" class="pt-1" type="textarea" :autosize="{minRows: 15,maxRows: 20}" placeholder="..."/>
            </d-col>
            <d-col md="6">
              <div class="mx-1 pt-2"><code>Data Receiver: {{apiPath.replace("/api/v1","") + '/xss?salt=salt&data=xxxx'}}</code></div>
              <div class="mx-1 pt-2"><code>Parameter: url data extend</code></div>
            </d-col>
          </d-form-row>
        </d-form>
        <br>
        <div class="mx-4">
          <d-button @click="deletePayload(payloadItem.pid)" type="submit" class="btn-warning mr-2">
            <i class="material-icons mr-1">restore_from_trash</i><strong>Trash</strong></d-button>
          <d-button @click="updatePayload(payloadItem.pid)" type="submit " class="btn-accent">
            <i class="material-icons mr-1">border_color</i><strong>Update</strong></d-button>
        </div>
      </d-col>
    </d-row>
    <Modal
        v-model="openNewPayloadModal"
        scrollable
        footer-hide
        title="New Payload">
      <div>
        <d-row>
          <d-col lg="12" md="12" sm="12">
            <Input v-model="newPayloadValue.name" class="pt-1" placeholder="Payload name..."></Input>
          </d-col>
          <d-col class="pt-2"  lg="12" md="12" sm="12">
            <Input v-model="newPayloadValue.value" class="pt-1" type="textarea" :autosize="{minRows: 8,maxRows: 15}" placeholder="..."/>
          </d-col>
          <d-col class="pt-4 text-right" lg="12" md="12" sm="12">
            <Button @click="addNewPayload">
              <i class="material-icons mr-1">add_box</i>
              Submit
            </Button>
          </d-col>
        </d-row>
      </div>
    </Modal>
  </div>
</template>

<script>
  export default {
    name: "XssPayloads",
    data() {
      return {
        spinShow: true,
        items: [],
        payloadItem: {
          name: "", value: "", pid: "",
        },
        reqApiPath: "/exploit/xss/payload",
        openNewPayloadModal: false,
        newPayloadValue: {
          name: "", value: ""
        }
      }
    },
    mounted() {
      this.getData()
    },
    methods: {
      getData() {
        this.$axios.get(this.reqApiPath).then(response => {
          let status = response['data']['status'];
          let data = response['data']['result'];
          if (status['status'] === 'success') {
            this.items = [];
            this.items = data;
            this.payloadItem.name = this.items[0]['name'];
            this.payloadItem.value = this.items[0]['value'];
            this.payloadItem.pid = this.items[0]['pid'];
          } else {
            this.$message.error(status['message']);
          }
        })
      },
      addNewPayload(){
        if (this.newPayloadValue.name.length===0||this.newPayloadValue.value.length===0) {
          return
        }
        this.$axios.post(this.reqApiPath, this.newPayloadValue).then(response => {
          let status = response['data']['status'];
          if (status['status'] === 'success') {
            this.$message.success(status['message']);
            this.openNewPayloadModal = false;
            this.newPayloadValue.name = "";
            this.newPayloadValue.value = "";
            // this.getData()
            window.location.reload()
          } else {
            this.$message.error(status['message']);
            this.openNewPayloadModal = false;
            this.getData()
          }
        })
      },
      selectPayload() {
        for (let i=0;i<this.items.length;i++) {
          if (this.items[i]['name'] === this.payloadItem.name) {
            this.payloadItem.name = this.items[i]['name'];
            this.payloadItem.value = this.items[i]['value'];
            this.payloadItem.pid = this.items[i]['pid'];
          }
        }
      },
      deletePayload(pid) {
        this.$Modal.confirm({
          title: 'WARNING',
          content: 'Are you sure you want to delete this item?',
          closable: true,
          okText: 'OK',
          cancelText: 'Cancel',
          onOk: () => {
            this.$axios.delete(this.reqApiPath + '/' + pid).then(response => {
              let status = response['data']['status'];
              if (status['status'] === 'success') {
                this.$message.success(status['message']);
                // this.getData()
                window.location.reload()
              } else {
                this.$message.error(status['message']);
                this.getData()
              }
            })
          }});
      },
      updatePayload(pid) {
        this.$axios.put(this.reqApiPath + '/' + pid, {"value": this.payloadItem.value}).then(response => {
          let status = response['data']['status'];
          if (status['status'] === 'success') {
            this.$message.success(status['message']);
            this.getData()
            // window.location.reload()
          } else {
            this.$message.error(status['message']);
            this.getData()
          }
        })
      }
    }
  }
</script>

<style scoped>

</style>
